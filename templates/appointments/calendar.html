{% extends 'base.html' %}
{% load static %}
{% block content %}
{% csrf_token %}
<div class="container">
    <h1></h1>
    {% if user.lawyerprofile %}
        <a href="{% url 'appointments:generate_slots_days' %}" class="btn btn-primary mb-3">
            Генерировать слоты по выбранным дням
        </a>
        <div class="mb-3">
            <button id="deleteAllSlotsBtn" class="btn btn-danger">Удалить все слоты</button>
        </div>
    {% endif %}
    <!-- Навигация и заголовок -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-outline-primary" onclick="changeMonth(-1)">&laquo; Предыдущий</button>
        <h2 class="text-center mb-0" id="month-header"></h2>
        <button class="btn btn-outline-primary" onclick="changeMonth(1)">Следующий &raquo;</button>
    </div>

    <!-- Дни недели -->
    <div class="row row-cols-7 weekdays-row mb-2">
        <div class="col text-center fw-bold">Пн</div>
        <div class="col text-center fw-bold">Вт</div>
        <div class="col text-center fw-bold">Ср</div>
        <div class="col text-center fw-bold">Чт</div>
        <div class="col text-center fw-bold">Пт</div>
        <div class="col text-center fw-bold">Сб</div>
        <div class="col text-center fw-bold">Вс</div>
    </div>

    <!-- Сетка календаря -->
    <div id="calendar-grid"></div>

    <!-- Блок выбора времени -->
    <div id="time-slots" class="mt-4 card" style="display: none;">
        <div class="card-body">
            <h4 class="card-title" id="selected-date"></h4>
            <div id="choose-time-label" class="mb-2 text-primary fw-bold" style="display: none;">
                Выберите время для записи
            </div>
            {% if user.lawyerprofile %}
                <button id="confirm-btn" class="btn btn-danger w-100 mb-3" style="display: none;" onclick="deleteSlot(selectedSlotId)">
                    Удалить слот
                </button>
            {% else %}
                <button id="confirm-btn" class="btn btn-success w-100 mb-3" style="display: none;" onclick="bookSlot(selectedSlotId)">
                    Записаться
                </button>
            {% endif %}
            <div id="slot-list" class="list-group mb-3"></div>
            {% if user.lawyerprofile %}
                <button id="add-time-btn" class="btn btn-primary w-100" onclick="openCreateSlotModal(selectedDateForSlot)">Добавить время</button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal для подтверждения удаления -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ВЫ действительно хотите удалить все слоты?</p>
                <p class="text-danger" id="deleteCountdown"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>Удалить</button>
            </div>
        </div>
    </div>
</div>

<!-- Замена формы создания слота -->
<div id="createSlotForm" style="display: none;" class="card mt-3 mx-auto" style="max-width: 400px;">
    <div class="card-body p-4">
        <h5 class="card-title mb-4 text-center">Создание слота на <span id="selectedDateDisplay"></span></h5>
        <div class="row g-3">
            <div class="col-12">
                <label for="slotStartTime" class="form-label mb-2">Выберите время</label>
                <select id="slotStartTime" class="form-select form-select-sm">
                    <option value="">Выберите время</option>
                    <option value="09:00">09:00</option>
                    <option value="09:30">09:30</option>
                    <option value="10:00">10:00</option>
                    <option value="10:30">10:30</option>
                    <option value="11:00">11:00</option>
                    <option value="11:30">11:30</option>
                    <option value="12:00">12:00</option>
                    <option value="12:30">12:30</option>
                    <option value="13:00">13:00</option>
                    <option value="13:30">13:30</option>
                    <option value="14:00">14:00</option>
                    <option value="14:30">14:30</option>
                    <option value="15:00">15:00</option>
                    <option value="15:30">15:30</option>
                    <option value="16:00">16:00</option>
                    <option value="16:30">16:30</option>
                    <option value="17:00">17:00</option>
                </select>
            </div>
        </div>
        <div class="mt-4 d-flex justify-content-between gap-2">
            <button type="button" class="btn btn-secondary btn-sm flex-grow-1" onclick="hideCreateSlotForm()">
                Отмена
            </button>
            <button type="button" class="btn btn-primary btn-sm flex-grow-1" onclick="createSlot()">
                Создать слот
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const isLawyer = {{ user.lawyerprofile|yesno:"true,false" }};
    let slotsData = JSON.parse('{{ slots_json|escapejs }}');
    let currentDate = new Date('{{ current_date }}');
    window.selectedSlotId = null;
    window.selectedDateForSlot = null;
    const monthNames = [
        "Январь", "Февраль", "Март", "Апрель",
        "Май", "Июнь", "Июль", "Август",
        "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
    ];

    // Основная функция генерации календаря
    function initCalendar() {
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const today = new Date().setHours(0,0,0,0);
        
        // Обновление заголовка
        document.getElementById('month-header').textContent = 
            `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

        // Генерация сетки
        let calendarHTML = '<div class="row row-cols-7 g-1">';
        let dayCounter = 0;

        // Пустые ячейки в начале
        const startDay = (firstDay.getDay() + 6) % 7; // 0-Пн, 1-Вт...6-Вс
        for (let i = 0; i < startDay; i++) {
            calendarHTML += '<div class="col p-1"></div>';
            dayCounter++;
        }

        // Заполнение дней месяца
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const currentDayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            currentDayDate.setHours(0,0,0,0);
            
            // Проверяем, является ли день прошедшим
            const isPast = currentDayDate.getTime() < today;
            
            // Проверяем наличие слотов
            const hasSlots = slotsData.some(s => {
                const slotDate = new Date(s.fields.start_time);
                return (
                    slotDate.getDate() === day &&
                    slotDate.getMonth() === currentDate.getMonth() &&
                    slotDate.getFullYear() === currentDate.getFullYear() &&
                    !s.fields.is_booked
                );
            });

            console.log(`Day ${day}: isPast=${isPast}, hasSlots=${hasSlots}`); // Отладочный вывод

            // --- изменено: если день в прошлом, не добавляем onclick ---
            calendarHTML += `
                <div class="col p-1">
                    <div class="calendar-day ${isPast ? 'past-day' : ''} ${hasSlots ? 'available-day' : ''}"
                        data-date="${currentDayDate.toISOString().split('T')[0]}"
                        ${!isPast ? 'onclick="showTimeSlots(this)" style="cursor: pointer;"' : 'style="cursor: not-allowed;"'}
                    >
                        ${day}
                        ${hasSlots ? '<div class="slot-indicator"></div>' : ''}
                    </div>
                </div>`;
            
            dayCounter++;
            // Перенос строки каждые 7 дней
            if (dayCounter % 7 === 0) {
                calendarHTML += '</div><div class="row row-cols-7 g-1">';
            }
        }

        // Добавление пустых ячеек в конце
        while (dayCounter % 7 !== 0) {
            calendarHTML += '<div class="col p-1"></div>';
            dayCounter++;
        }

        document.getElementById('calendar-grid').innerHTML = calendarHTML + '</div>';
        document.getElementById('time-slots').style.display = 'none';
    }

    // Функция загрузки слотов
    async function loadSlots(year, month) {
        try {
            console.log(`Loading slots for ${year}-${month}`);
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Обновляем URL для API
            const response = await fetch(`/appointments/slots/?year=${year}&month=${month}`, {
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json',
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
            
            slotsData = JSON.parse(data.slots);
            console.log(`data.slots: ${data.slots}`);
            console.log(`Loaded ${slotsData.length} slots for ${year}-${month}`);
            
            initCalendar();
        } catch (error) {
            console.error('Error loading slots:', error);
            alert('Ошибка при загрузке данных. Попробуйте обновить страницу.');
        }
    }

    // Обновляем функцию смены месяца
    window.changeMonth = function(offset) {
        const newDate = new Date(currentDate);
        newDate.setMonth(newDate.getMonth() + offset);
        currentDate = newDate;
        
        // ВАЖНО: месяцы в JavaScript начинаются с 0, поэтому добавляем 1
        const year = newDate.getFullYear();
        const month = newDate.getMonth() + 1;
        
        console.log(`Changing to ${year}-${month}`); // Отладочный вывод
        loadSlots(year, month);
    }

    // Показать доступное время
    window.showTimeSlots = function(element) {
        if (element.classList.contains('past-day')) {
            return; // Не реагировать на клик по прошедшему дню
        }
        const day = parseInt(element.textContent);
        // Construct local date string manually (YYYY-MM-DD)
        selectedDateForSlot = `${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        window.selectedDateForSlot = selectedDateForSlot;
        const selectedDate = new Date(
            currentDate.getFullYear(),
            currentDate.getMonth(),
            day
        );
        
        // Сброс выбора
        document.querySelectorAll('.calendar-day').forEach(d => 
            d.classList.remove('selected-day'));
        element.classList.add('selected-day');
        
        // Фильтрация слотов
        const filteredSlots = slotsData.filter(s => {
            const slotDate = new Date(s.fields.start_time);
            return (
                slotDate.getDate() === day &&
                slotDate.getMonth() === currentDate.getMonth() &&
                !s.fields.is_booked
            );
        });
        // Показываем надпись "Выберите время для записи" только если есть свободные слоты
        if (filteredSlots.length > 0) {
            document.getElementById('choose-time-label').style.display = 'block';
        } else {
            document.getElementById('choose-time-label').style.display = 'none';
        }
        // Группируем слоты по времени
        const timeGroups = {};
        filteredSlots.forEach(s => {
            const time = new Date(s.fields.start_time);
            const hour = time.getHours();
            if (!timeGroups[hour]) {
                timeGroups[hour] = [];
            }
            timeGroups[hour].push(s);
        });
        // Создаем HTML для сгруппированных слотов
        const slotsHTML = Object.entries(timeGroups).map(([hour, slots]) => `
            <div class="time-group mb-3">
                <h5 class="time-header">${hour}:00</h5>
                <div class="time-slots-grid">
                    ${slots.map(s => `<button class="time-slot-btn ${isLawyer ? 'lawyer-slot' : ''}" onclick="selectSlot('${s.pk}')">
                        ${new Date(s.fields.start_time).toLocaleTimeString('ru-RU', {
                            hour: '2-digit', 
                            minute: '2-digit'
                        })}
                    </button>`).join('')}
                </div>
            </div>
        `).join('');
        document.getElementById('selected-date').textContent = 
            selectedDate.toLocaleDateString('ru-RU', { 
                day: 'numeric', 
                month: 'long',
                weekday: 'long'
            });
        document.getElementById('slot-list').innerHTML = slotsHTML;
        document.getElementById('time-slots').style.display = 'block';
        document.getElementById('confirm-btn').style.display = 'none';
    }
    // Обновляем функцию выбора слота
    window.selectSlot = function(slotId) {
        window.selectedSlotId = slotId;
        // Убираем активный класс со всех кнопок времени
        document.querySelectorAll('.time-slot-btn').forEach(btn =>
            btn.classList.remove('active', 'selected'));
        // Находим кнопку, на которой произошло событие
        const targetButton = document.querySelector(`.time-slot-btn[onclick="selectSlot('${slotId}')"]`);
        // Проверяем, что кнопка была найдена
        if (targetButton) {
            // Добавляем активный класс выбранной кнопке
            targetButton.classList.add('active', 'selected');
        }
        // Показываем кнопку подтверждения
        document.getElementById('confirm-btn').style.display = 'block';
    }
    window.bookSlot = function(slotId) {
        window.location.href = `/appointments/create/${slotId}/`;
    }
    window.deleteSlot = async function(slotId) {
        if (confirm("Вы уверены, что хотите удалить этот слот?")) {
            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/appointments/delete_slot/${slotId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    alert("Слот успешно удален.");
                    window.location.reload(); // Refresh the page
                } else {
                    alert("Ошибка при удалении слота.");
                }
            } catch (error) {
                console.error("Ошибка:", error);
                alert("Произошла ошибка при отправке запроса.");
            }
        }
    }
    window.openCreateSlotModal = function(date) {
        const isLawyer = {{ user.lawyerprofile|yesno:"true,false" }};
        if (!isLawyer) return;
        
        if(date) {
            selectedDateForSlot = date;
            const formattedDate = new Date(date).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('selectedDateDisplay').textContent = formattedDate;
            document.getElementById('createSlotForm').style.display = 'block';
            document.getElementById('add-time-btn').style.display = 'none';
            document.getElementById('slotStartTime').value = ''; // Сброс выбора времени
        }
    }

    window.hideCreateSlotForm = function() {
        document.getElementById('createSlotForm').style.display = 'none';
        document.getElementById('add-time-btn').style.display = 'block';
    }

    window.createSlot = async function() {
        const startTime = document.getElementById('slotStartTime').value;
        
        if (!startTime) {
            alert('Пожалуйста, выберите время.');
            return;
        }

        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const response = await fetch('/appointments/create_slot_from_day/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: selectedDateForSlot,
                    startTime: startTime
                })
            });

            if (response.ok) {
                document.getElementById('createSlotForm').style.display = 'none';
                document.getElementById('add-time-btn').style.display = 'block';
                document.getElementById('slotStartTime').value = '';
                
                await loadSlots(currentDate.getFullYear(), currentDate.getMonth() + 1);
                
                const selectedDayElement = document.querySelector(`[data-date="${selectedDateForSlot}"]`);
                if (selectedDayElement) {
                    showTimeSlots(selectedDayElement.parentElement.querySelector('.calendar-day'));
                    selectedDayElement.parentElement.querySelector('.calendar-day').classList.add('selected-day');
                }
                
                // После успешного создания перезагружаем страницу для отображения сообщения
                window.location.reload();
            } else {
                alert('Ошибка при создании слота');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при отправке запроса');
        }
    }

    // Добавляем обработчик для кнопки удаления
    document.getElementById('deleteAllSlotsBtn')?.addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const countdownEl = document.getElementById('deleteCountdown');
        modal.show();
        
        let countdown = 5;
        confirmBtn.disabled = true;
        
        const timer = setInterval(() => {
            countdown--;
            countdownEl.textContent = `Подтверждение будет доступно через ${countdown} секунд...`;
            
            if (countdown <= 0) {
                clearInterval(timer);
                confirmBtn.disabled = false;
                countdownEl.textContent = 'Теперь вы можете подтвердить удаление';
            }
        }, 1000);
    });

    // Добавляем обработчик для кнопки подтверждения удаления
    document.getElementById('confirmDeleteBtn')?.addEventListener('click', async function() {
        try {
            const response = await fetch('/appointments/clear-all-slots/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Произошла ошибка при удалении слотов');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Произошла ошибка при отправке запроса');
        }
    });

    // Первоначальная инициализация
    loadSlots(currentDate.getFullYear(), currentDate.getMonth() + 1);
});
</script>
<style>
.calendar-day {
    position: relative;
    height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s;
    cursor: pointer;
    border: 2px solid transparent;
}
.weekdays-row {
    background: #e9ecef;
    border-radius: 8px;
    padding: 10px 0;
}
.available-day {
    background: #d4edda !important;
    border-color: #c3e6cb !important;
}
.past-day {
    background: #f8f9fa !important;
    color: #adb5bd !important;
    cursor: not-allowed;
}
.selected-day {
    background: #cce5ff !important;
    border-color: #b8daff !important;
    transform: scale(1.05);
}
.list-group-item.active {
    background-color: #e3f2fd;
    border-color: #90caf9;
}
#time-slots {
    animation: fadeIn 0.3s ease;
    max-width: 600px;
    margin: 0 auto;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
.calendar-day:not(.past-day):hover {
    transform: scale(1.05);
    transition: transform 0.2s;
}
.available-day:not(.past-day) {
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.slot-indicator {
    width: 8px;
    height: 8px;
    background-color: #28a745;
    border-radius: 50%;
    position: absolute;
    bottom: 8px;
}
#createSlotForm {
    max-width: 400px;
    margin: 0 auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#createSlotForm .card-body {
    padding: 1.5rem;
}

#createSlotForm .form-select {
    font-size: 0.9rem;
    padding: 0.375rem 0.75rem;
}

#createSlotForm .btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

#selectedDateDisplay {
    color: #007bff;
    font-weight: 500;
}
.available-day:not(.past-day):hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.time-group {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
}
.time-header {
    color: #495057;
    margin-bottom: 10px;
    font-weight: 500;
}
.time-slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
}
.time-slot-btn {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 8px 12px;
    transition: all 0.2s;
    cursor: pointer;
    font-size: 0.9rem;
    width: 100%;
}
.time-slot-btn:hover {
    background: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.time-slot-btn.active {
    background: #cce5ff !important;
    border-color: #b8daff !important;
    color: #004085 !important;
    font-weight: bold;
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
#selected-date {
    color: #495057;
    text-transform: capitalize;
    margin-bottom: 20px;
    font-size: 1.25rem;
}
#confirm-btn {
    margin-top: 20px;
    padding: 12px;
    font-weight: 500;
    font-size: 1.1rem;
    transition: all 0.3s;
}
#confirm-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* --- Мобильная адаптивность --- */
@media (max-width: 768px) {
    .container {
        padding: 0 5px;
    }
    .calendar-day {
        height: 48px;
        font-size: 0.95rem;
        padding: 2px 0;
    }
    .weekdays-row {
        font-size: 0.9rem;
        padding: 6px 0;
    }
    .row.row-cols-7 {
        margin-left: 0;
        margin-right: 0;
    }
    .row.row-cols-7 > .col {
        padding-left: 2px;
        padding-right: 2px;
    }
    #calendar-grid .row {
        margin-left: 0;
        margin-right: 0;
    }
    #calendar-grid .col {
        padding-left: 2px;
        padding-right: 2px;
    }
    #time-slots {
        max-width: 100%;
        padding: 0;
    }
    .time-group {
        padding: 8px;
    }
    .time-header {
        font-size: 1rem;
        margin-bottom: 6px;
    }
    .time-slots-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 6px;
    }
    .time-slot-btn {
        font-size: 0.85rem;
        padding: 6px 4px;
    }
    #selected-date {
        font-size: 1rem;
        margin-bottom: 12px;
    }
    #confirm-btn {
        font-size: 1rem;
        padding: 10px;
    }
    #createSlotForm {
        padding: 8px;
        font-size: 0.95rem;
    }
    #createSlotForm input[type="time"] {
        padding: 6px;
        font-size: 0.95rem;
    }
    #createSlotForm button {
        padding: 8px 10px;
        font-size: 0.95rem;
    }
    .d-flex.justify-content-between.align-items-center.mb-4 {
        flex-direction: column;
        gap: 8px;
    }
    .d-flex.justify-content-between.align-items-center.mb-4 h2 {
        font-size: 1.1rem;
    }
}

/* Для очень маленьких экранов */
@media (max-width: 480px) {
    .calendar-day {
        height: 36px;
        font-size: 0.8rem;
    }
    .weekdays-row {
        font-size: 0.8rem;
    }
    .time-header {
        font-size: 0.95rem;
    }
    .time-slots-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    #selected-date {
        font-size: 0.95rem;
    }
    #confirm-btn {
        font-size: 0.95rem;
        padding: 8px;
    }
}

/* Улучшение скролла для блока времени на мобильных */
#time-slots {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* Кнопки навигации календаря */
@media (max-width: 480px) {
    .btn.btn-outline-primary {
        font-size: 0.9rem;
        padding: 6px 10px;
    }
}

/* Уменьшить отступы у slot-indicator */
.slot-indicator {
    bottom: 4px;
    right: 4px;
}

/* Убрать лишние отступы у карточек на мобильных */
@media (max-width: 480px) {
    .card {
        margin-bottom: 8px;
    }
}
</style>
{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'appointments/css/calendar.css' %}">
{% endblock %}