{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block extra_head %}
<style>
    .detail-card {
        border: none;
        border-radius: 0.75rem; /* Более скругленные углы */
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.075) !important; /* Мягче тень */
    }
    .detail-card-header {
        background-color: var(--bs-primary); /* Используем переменную Bootstrap */
        color: white;
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
        padding: 1rem 1.5rem;
    }
    .detail-card-header h3 {
        margin-bottom: 0;
        font-weight: 500; /* Чуть жирнее */
        font-size: 1.5rem; /* Немного крупнее заголовок карточки */
    }
    .detail-card-body {
        padding: 1.5rem; /* Увеличил общий padding */
    }
    .info-grid p {
        margin-bottom: 0.85rem; /* Немного увеличил отступ */
        font-size: 1rem; /* Стандартный размер шрифта Bootstrap */
    }
    .info-grid p strong {
        min-width: 140px; /* Выравнивание "ключ: значение" */
        display: inline-block;
        color: #495057; /* Темнее для ключа */
        font-weight: 500; /* Полужирный для ключа */
    }
    .status-badge-lg { /* Увеличенный бейдж статуса */
        font-size: 0.95rem; /* Чуть уменьшил, чтобы не был слишком громоздким */
        padding: 0.45em 0.75em;
        font-weight: 500;
    }
    .document-list .list-group-item {
        border-left: 0;
        border-right: 0;
        padding-left: 0; /* Убрали внутренние отступы у элемента списка */
        padding-right: 0;
        background-color: transparent; /* Прозрачный фон для элементов списка */
    }
    .document-list .list-group-item:first-child {
        border-top: 0;
    }
    .document-list .list-group-item:last-child {
        border-bottom: 0;
    }
    .document-list a {
        font-weight: 500;
        color: var(--bs-primary); /* Ссылка цветом primary */
    }
    .document-list a:hover {
        text-decoration: underline;
    }
    .upload-form-section {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef; /* Тонкая граница */
        border-radius: 0.5rem;
        margin-top: 1.5rem; /* Отступ сверху */
    }
    .action-buttons .btn {
        min-width: 200px; /* Одинаковая ширина для кнопок действий */
        padding-top: 0.6rem;
        padding-bottom: 0.6rem;
        font-size: 0.95rem;
    }

    /* Стили для кастомной кнопки загрузки файла */
    .custom-file-upload input[type="file"] {
        display: none; /* Скрываем оригинальный input */
    }

    .custom-file-upload .file-name-display {
        font-size: 0.9em;
        margin-left: 0.75rem; /* Отступ слева от кнопки */
        color: #6c757d; /* text-muted */
        vertical-align: middle; /* Выравнивание по центру с кнопкой */
    }
    .custom-file-upload label.btn-file-select {
        cursor: pointer;
        padding: 0.375rem 0.75rem; /* Стандартный padding кнопки BS */
        font-size: 1rem; /* Стандартный размер шрифта BS */
    }

    @media (max-width: 767px) { /* md breakpoint */
        .info-grid p strong {
            min-width: auto; /* Убираем мин. ширину */
            display: block; /* Ключ над значением на мобильных */
            margin-bottom: 0.1rem;
            font-weight: 600; /* Делаем ключ жирнее на мобильных */
        }
        .info-grid p {
            margin-bottom: 1rem; /* Больше отступ между парами на мобильных */
        }
        .detail-card-body {
            padding: 1.25rem;
        }
        .detail-card-header h3 {
            font-size: 1.3rem;
        }
         .action-buttons .btn {
            width: 100%;
            margin-bottom: 0.75rem; /* Отступ между кнопками */
            min-width: auto;
        }
        .action-buttons .btn:last-child {
            margin-bottom: 0;
        }
        .document-list .d-flex { /* На мобильных элементы могут идти друг под другом */
            flex-direction: column;
            align-items: flex-start !important;
        }
        .document-list .d-flex > div:first-child { /* Блок с названием и описанием */
            margin-bottom: 0.5rem;
        }
        .document-list .text-nowrap { /* Убираем запрет переноса для даты/автора */
            white-space: normal;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4 my-md-5" style="max-width: 860px;"> {# Ограничиваем ширину контейнера #}
    <div class="card detail-card">
        <div class="card-header detail-card-header">
            <h3>Детали записи <span class="fw-normal">#{{ appointment.id }}</span></h3>
        </div>
        <div class="card-body detail-card-body">
            <div class="info-grid mb-4">
                <p><strong>Клиент:</strong> {{ appointment.client.full_name }}</p>
                <p><strong>Юрист:</strong> {{ appointment.lawyer.full_name }}</p>
                <p><strong>Дата и время:</strong> {{ appointment.date|date:"l, j F Y, H:i" }} (МСК)</p>
                <p><strong>Статус:</strong>
                    <span class="badge status-badge-lg
                        {% if appointment.status == 'Pending' %}bg-warning text-dark{% elif appointment.status == 'Approved' %}bg-success text-white{% elif appointment.status == 'Rejected' %}bg-danger text-white{% else %}bg-secondary text-white{% endif %}">
                        {{ appointment.get_status_display }}
                    </span>
                </p>
            </div>

            {# Кнопка отмены для клиента #}
            {% if is_client_owner and can_cancel %}
            <div class="mb-4 pb-3 border-bottom action-buttons">
                <a href="{% url 'appointments:cancel_appointment_client' appointment.id %}" class="btn btn-lg btn-warning d-inline-flex align-items-center justify-content-center">
                    <i class="bi bi-calendar-x-fill me-2"></i>Отменить запись
                </a>
            </div>
            {% endif %}

            <h4 class="mb-3 mt-2 fw-normal"><i class="bi bi-folder2-open me-2 text-primary"></i>Документы к этой записи</h4>
            {% if documents %}
                <ul class="list-group list-group-flush document-list mb-4">
                {% for doc in documents %}
                    <li class="list-group-item py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-file-earmark-text text-primary me-2 fs-5 align-middle"></i>
                                <a href="{% url 'appointments:download_appointment_document' doc.id %}" target="_blank" class="text-decoration-none align-middle">{{ doc.document.name|filename }}</a>
                                {% if doc.description %}<small class="text-muted d-block ps-4 ms-3"><em>{{ doc.description }}</em></small>{% endif %}
                            </div>
                            <small class="text-muted text-nowrap text-end">
                                {% if doc.uploaded_by %}
                                    Загрузил: {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.email }}<br>
                                {% endif %}
                                {{ doc.uploaded_at|date:"d.m.Y H:i" }}
                            </small>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <div class="alert alert-light text-center border-dashed" role="alert"> {# Добавил border-dashed для интереса #}
                    <i class="bi bi-info-circle me-2"></i>К этой записи документы не прикреплены.
                </div>
            {% endif %}

            {# Форма загрузки документа к записи (для клиента или юриста) #}
            {% if is_client_owner or is_lawyer_for_appointment %}
            <div class="upload-form-section p-3 p-md-4">
                <h5 class="mb-3 fw-normal"><i class="bi bi-cloud-arrow-up-fill me-2 text-success"></i>Прикрепить новый документ</h5>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% comment %} Поле description {% endcomment %}
                    {% if upload_form.description %}
                    <div class="mb-3">
                        {{ upload_form.description.label_tag }}
                        {{ upload_form.description }}
                        {% if upload_form.description.errors %}
                            <div class="text-danger small mt-1">{{ upload_form.description.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% comment %} Кастомный блок для поля 'document' {% endcomment %}
                    {% if upload_form.document %}
                    <div class="mb-3">
                        {{ upload_form.document.label_tag }}
                        <div class="custom-file-upload d-flex align-items-center"> {# d-flex для выравнивания кнопки и имени файла #}
                            {# Скрываем оригинальный input type="file" #}
                            {{ upload_form.document }}
                            {# Наша кастомная кнопка #}
                            <label for="{{ upload_form.document.id_for_label }}" class="btn btn-outline-primary btn-file-select">
                                <i class="bi bi-paperclip me-1"></i> Выбрать файл...
                            </label>
                            {# Место для отображения имени выбранного файла #}
                            <span class="file-name-display">Файл не выбран</span>
                        </div>
                        {% if upload_form.document.help_text %}
                            <small class="form-text text-muted d-block mt-1">{{ upload_form.document.help_text }}</small>
                        {% endif %}
                        {% if upload_form.document.errors %}
                            <div class="text-danger small mt-1">{{ upload_form.document.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if upload_form.non_field_errors %}
                        <div class="alert alert-danger small py-2">
                            {{ upload_form.non_field_errors|join:", " }}
                        </div>
                    {% endif %}

                    <button type="submit" class="btn btn-success mt-2 d-inline-flex align-items-center">
                        <i class="bi bi-upload me-2"></i> Загрузить документ
                    </button>
                </form>
            </div>
            {% endif %}

            <div class="mt-4 pt-3 border-top text-center action-buttons">
                {% if is_lawyer_for_appointment %}
                     <a href="{% url 'appointments:lawyer_dashboard' %}" class="btn btn-outline-secondary d-inline-flex align-items-center justify-content-center">
                        <i class="bi bi-arrow-left-circle-fill me-2"></i>Назад к панели
                    </a>
                {% elif is_client_owner %}
                    <a href="{% url 'accounts:client_profile' %}" class="btn btn-outline-secondary d-inline-flex align-items-center justify-content-center">
                        <i class="bi bi-person-circle me-2"></i>Назад к профилю
                    </a>
                {% else %}
                     {# Если ни то, ни другое (например, админ), можно дать ссылку на главную или админку #}
                     <a href="{% url 'home' %}" class="btn btn-outline-secondary d-inline-flex align-items-center justify-content-center">
                        <i class="bi bi-house-door-fill me-2"></i>На главную
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик для кастомной кнопки выбора файла
    const fileUploadContainers = document.querySelectorAll('.custom-file-upload');

    fileUploadContainers.forEach(function(container) {
        const input = container.querySelector('input[type="file"]');
        const displaySpan = container.querySelector('.file-name-display');

        if (input && displaySpan) {
            input.addEventListener('change', function(e) {
                if (input.files.length > 0) {
                    displaySpan.textContent = input.files[0].name;
                    displaySpan.classList.remove('text-muted'); // Делаем текст обычным
                } else {
                    displaySpan.textContent = 'Файл не выбран';
                    displaySpan.classList.add('text-muted'); // Возвращаем серый цвет
                }
            });
        }
    });
});
</script>
{% endblock %}